---
title: 'SQL Recipe Directory'
description: "A curated set of BigQuery SQL snippets to answer common questions using SourceMedium tables"
icon: "code"
---

### Overview

Use these queries as starting points for analysis in BigQuery. Replace `your_project` with your BigQuery project ID (e.g., `sm-yourcompany`) and `your-sm_store_id` with your store identifier.

<Tip>
**Query Standards:**
- Always include `is_order_sm_valid = TRUE` for order-based analyses
- Use `your_project.sm_transformed_v2.*` for standard tables
- Use `your_project.sm_experimental.*` for MTA tables
</Tip>

If you're not sure which table to use, start with: [`obt_orders`](/data-activation/data-tables/sm_transformed_v2/obt_orders) and [`obt_order_lines`](/data-activation/data-tables/sm_transformed_v2/obt_order_lines).

## Product Insights
<AccordionGroup>
    <Accordion title='Most commonly ordered product combinations'>
        ```sql
        WITH RECURSIVE product_combos AS (
            -- Anchor: Start with individual products per order
            SELECT
                ol.sm_store_id,
                ol.sm_order_key,
                1 AS combo_length,
                CONCAT(ol.product_title, ' - ', ol.variant_title) AS combo,
                CONCAT(ol.product_title, ' - ', ol.variant_title) AS last_item
            FROM `your_project.sm_transformed_v2.obt_order_lines` AS ol
            WHERE ol.sm_store_id = 'your-sm_store_id'
              AND ol.is_order_sm_valid = TRUE

            UNION ALL

            -- Recursive: Build combinations up to 5 products
            SELECT
                ol.sm_store_id,
                ol.sm_order_key,
                pc.combo_length + 1,
                CONCAT(pc.combo, ', ', CONCAT(ol.product_title, ' - ', ol.variant_title)),
                CONCAT(ol.product_title, ' - ', ol.variant_title)
            FROM product_combos AS pc
            INNER JOIN `your_project.sm_transformed_v2.obt_order_lines` AS ol
                ON ol.sm_order_key = pc.sm_order_key
                AND CONCAT(ol.product_title, ' - ', ol.variant_title) > pc.last_item
            WHERE pc.combo_length < 5
              AND ol.is_order_sm_valid = TRUE
        )

        SELECT
            combo AS product_combinations,
            COUNT(DISTINCT sm_order_key) AS order_frequency,
            combo_length AS num_products
        FROM product_combos
        WHERE combo_length >= 2
        GROUP BY combo, combo_length
        HAVING order_frequency >= 100
        ORDER BY order_frequency DESC, combo ASC
        LIMIT 100;
        ```

    </Accordion>
</AccordionGroup>

## More recipes

We regularly add new recipes. If there’s a query you’d like added (subscription churn, cohort LTV curves, creative performance, etc.), reach out to your SourceMedium team and include the business question and the table(s) you’re using.
